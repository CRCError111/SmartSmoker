<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Программы копчения</title>
  <style>
    :root {
      --primary: #2c3e50;
      --accent: #3498db;
      --danger: #e74c3c;
      --success: #2ecc71;
      --bg: #f8f9fa;
      --card: #ffffff;
      --text: #212529;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    body { background: var(--bg); color: var(--text); padding: 16px; }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 20px; }
    .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
    button { padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-danger { background: var(--danger); color: white; }

    .program-list { margin-bottom: 30px; }
    .program-item {
      background: var(--card); padding: 14px; margin-bottom: 12px;
      border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex; justify-content: space-between; align-items: center;
    }

    /* Этапы — горизонтальная прокручиваемая лента */
    .steps-container {
      display: flex; overflow-x: auto; gap: 12px; padding: 12px 0;
      scrollbar-width: thin;
    }
    .step-card {
      min-width: 220px; background: #f8f9fa; padding: 12px; border-radius: 8px;
      border: 1px solid #dee2e6;
    }
    .step-card input, .step-card select {
      width: 100%; padding: 6px; margin: 4px 0; border: 1px solid #ccc; border-radius: 4px;
    }
    .step-actions { display: flex; gap: 6px; margin-top: 8px; }
    .step-actions button { flex: 1; font-size: 12px; padding: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Программы копчения</h1>

    <div class="btn-group">
      <button class="btn-primary" onclick="createNewProgram()">+ Создать программу</button>
    </div>

    <div class="program-list" id="programList">
      <!-- Программы загружаются через API -->
    </div>
  </div>

  <script>
    let programs = [];

    async function loadPrograms() {
      const res = await fetch('/api/programs');
      programs = await res.json();
      renderPrograms();
    }

    function renderPrograms() {
      const list = document.getElementById('programList');
      list.innerHTML = '';

      for (const prog of programs) {
        const div = document.createElement('div');
        div.className = 'program-item';
        div.innerHTML = `
          <div>
            <strong>${prog.name}</strong>
            <small>(${prog.steps.length} этапов)</small>
            ${prog.isBuiltIn ? '<span style="color:#6c757d; font-size:12px;">[Встроенная]</span>' : ''}
          </div>
          <div>
            ${prog.isBuiltIn ? '' :
              `<button class="btn-primary" style="font-size:12px; padding:4px 8px;" onclick="editProgram('${prog.name}')">Редактировать</button>
               <button class="btn-danger" style="font-size:12px; padding:4px 8px;" onclick="deleteProgram('${prog.name}')">Удалить</button>`
            }
          </div>
        `;
        list.appendChild(div);
      }
    }

    function createNewProgram() {
      const name = prompt('Название программы:');
      if (!name || name.trim() === '') return;

      const newProg = {
        name: name.trim(),
        isBuiltIn: false,
        steps: [{
          targetTemp: 30,
          targetHumidity: 70,
          durationMinutes: 60,
          hysteresis: 2,
          waitForTemp: true,
          compressorPWM: -1 // Авто
        }]
      };

      editProgramInternal(newProg);
    }

    function editProgram(name) {
      const prog = programs.find(p => p.name === name);
      if (prog) editProgramInternal(prog);
    }

    function editProgramInternal(program) {
      let html = `
        <h2>Редактирование: ${program.name}</h2>
        <div class="steps-container" id="stepsEditor">
        </div>
        <div style="margin:15px 0;">
          <button class="btn-primary" onclick="addStep()">+ Добавить этап</button>
          <button class="btn-primary" style="margin-left:10px;" onclick="saveProgram('${program.name}')">Сохранить</button>
          <button class="btn-danger" style="margin-left:10px;" onclick="closeEditor()">Отмена</button>
        </div>
      `;

      document.body.innerHTML = html;
      renderStepsEditor(program.steps);
      window.currentProgram = program;
    }

    function renderStepsEditor(steps) {
      const container = document.getElementById('stepsEditor');
      container.innerHTML = '';
      steps.forEach((step, i) => {
        const card = document.createElement('div');
        card.className = 'step-card';
        card.innerHTML = `
          <strong>Этап ${i+1}</strong>
          <label>Темп. камеры (°C): <input type="number" value="${step.targetTemp}" onchange="window.currentProgram.steps[${i}].targetTemp=this.value"></label>
          <label>Время (мин): <input type="number" value="${step.durationMinutes}" onchange="window.currentProgram.steps[${i}].durationMinutes=this.value"></label>
          <!-- Остальные поля скрыты по ТЗ: редактируются только темп и время -->
          <div class="step-actions">
            <button class="btn-danger" onclick="removeStep(${i})">Удалить</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function addStep() {
      window.currentProgram.steps.push({
        targetTemp: 30,
        targetHumidity: 70,
        durationMinutes: 60,
        hysteresis: 2,
        waitForTemp: true,
        compressorPWM: -1
      });
      renderStepsEditor(window.currentProgram.steps);
    }

    function removeStep(index) {
      if (window.currentProgram.steps.length <= 1) {
        alert('Нельзя удалить последний этап');
        return;
      }
      window.currentProgram.steps.splice(index, 1);
      renderStepsEditor(window.currentProgram.steps);
    }

    async function saveProgram(oldName) {
      const prog = window.currentProgram;
      if (prog.steps.length === 0) {
        alert('Программа должна содержать хотя бы один этап');
        return;
      }

      try {
        const res = await fetch('/api/programs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            oldName: oldName,
            program: prog
          })
        });
        if (res.ok) {
          alert('Программа сохранена');
          loadPrograms();
        } else {
          alert('Ошибка сохранения: ' + await res.text());
        }
      } catch (e) {
        alert('Ошибка сети');
      }
    }

    async function deleteProgram(name) {
      if (!confirm(`Удалить программу "${name}"?`)) return;
      try {
        await fetch('/api/programs/' + encodeURIComponent(name), { method: 'DELETE' });
        loadPrograms();
      } catch (e) {
        alert('Ошибка удаления');
      }
    }

    function closeEditor() {
      loadPrograms();
    }

    // Загрузка при старте
    loadPrograms();
  </script>
</body>
</html>