<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartSmoker</title>
  <style>
    :root {
      --primary: #2c3e50;
      --accent: #3498db;
      --danger: #e74c3c;
      --success: #2ecc71;
      --bg: #f8f9fa;
      --card: #ffffff;
      --text: #212529;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    body { background: var(--bg); color: var(--text); padding: 16px; }
    .header { text-align: center; margin-bottom: 20px; }
    .network-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;
      background: var(--accent); color: white;
    }
    .status-card {
      background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .sensors-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 16px 0;
    }
    .sensor { background: #f1f3f5; padding: 10px; border-radius: 8px; text-align: center; }
    .programs-title { font-size: 18px; margin: 20px 0 12px; font-weight: 600; }
    .program-card {
      background: var(--card); border-radius: 10px; padding: 14px; margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;
    }
    .program-card button {
      background: var(--accent); color: white; border: none; padding: 6px 12px;
      border-radius: 6px; cursor: pointer; font-weight: 600;
    }
    .nav-icons {
      display: flex; justify-content: space-around; margin-top: 24px;
    }
    .nav-icon {
      display: flex; flex-direction: column; align-items: center; text-decoration: none;
      color: var(--text); font-size: 12px;
    }
    .nav-icon img { width: 48px; height: 48px; margin-bottom: 6px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>–£–º–Ω–∞—è –∫–æ–ø—Ç–∏–ª—å–Ω—è</h1>
    <!-- –°–µ—Ç–µ–≤–æ–π —Å—Ç–∞—Ç—É—Å (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è) -->
    <div id="networkStatus" class="network-badge">üì° –†–µ–∂–∏–º —Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–∞</div>
  </div>

  <div class="status-card">
    <div><strong>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</strong> <span id="systemStatus">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã</span></div>

    <div class="sensors-grid">
      <div class="sensor">–ö–∞–º–µ—Ä–∞: <strong id="tempChamber">--</strong>¬∞C</div>
      <div class="sensor">–î—ã–º: <strong id="tempSmoke">--</strong>¬∞C</div>
      <div class="sensor">–ü—Ä–æ–¥—É–∫—Ç: <strong id="tempProduct">--</strong>¬∞C</div>
      <div class="sensor">–í–ª–∞–∂–Ω–æ—Å—Ç—å: <strong id="humidity">--</strong>%</div>
    </div>

    <div>–¢–≠–ù: <span id="heaterStatus">–í—ã–∫–ª</span> | –î—ã–º: <span id="smokeStatus">0%</span></div>
  </div>

  <div class="programs-title">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</div>
  <div id="programsList">
    <!-- –ü—Ä–æ–≥—Ä–∞–º–º—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ API -->
  </div>

  <div class="nav-icons">
    <a href="/wifi" class="nav-icon">
      <img src="/wifi-icon.png" alt="Wi-Fi">
      –°–µ—Ç—å
    </a>
    <a href="/programs" class="nav-icon">
      <img src="/program-icon.png" alt="–ü—Ä–æ–≥—Ä–∞–º–º—ã">
      –ü—Ä–æ–≥—Ä–∞–º–º—ã
    </a>
  </div>

  <script>
    async function fetchState() {
      try {
        const res = await fetch('/api/state');
        if (!res.ok) return;
        const data = await res.json();

        // –°–µ—Ç—å
        const netBadge = document.getElementById('networkStatus');
        if (data.networkMode === 'STA') {
          netBadge.innerHTML = `üì∂ ${data.ssid} (${data.ip})`;
          netBadge.style.background = '#27ae60';
        } else {
          netBadge.innerHTML = `üì° ${data.ssid}`;
          netBadge.style.background = '#2980b9';
        }

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        const status = document.getElementById('systemStatus');
        if (data.mode === 'RUNNING') {
          status.textContent = `–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: ${data.currentProgramName} ‚Äî –≠—Ç–∞–ø ${data.currentStepIndex + 1} (–æ—Å—Ç–∞–ª–æ—Å—å ${data.stepTimeLeft})`;
        } else {
          status.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã';
        }

        // –î–∞—Ç—á–∏–∫–∏
        document.getElementById('tempChamber').textContent = data.tempChamber.toFixed(1);
        document.getElementById('tempSmoke').textContent = data.tempSmoke.toFixed(1);
        document.getElementById('tempProduct').textContent = data.tempProduct.toFixed(1);
        document.getElementById('humidity').textContent = data.humidity.toFixed(0);

        // –ê–∫—Ç—é–∞—Ç–æ—Ä—ã
        document.getElementById('heaterStatus').textContent = data.heaterOn ? '–í–∫–ª' : '–í—ã–∫–ª';
        document.getElementById('smokeStatus').textContent = `${data.smokePWM}%`;

        // –ü—Ä–æ–≥—Ä–∞–º–º—ã
        const programsList = document.getElementById('programsList');
        let html = '';
        for (const prog of data.programs) {
          html += `
            <div class="program-card">
              <div><strong>${prog.name}</strong><br>
                <small>${prog.steps.length} —ç—Ç–∞–ø–æ–≤</small>
              </div>
              <button onclick="startProgram('${prog.name}')">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
            </div>
          `;
        }
        programsList.innerHTML = html;
      } catch (e) {
        console.warn('Failed to fetch state:', e);
      }
    }

    async function startProgram(name) {
      try {
        await fetch('/api/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ program: name })
        });
        alert('–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–ø—É—â–µ–Ω–∞!');
        fetchState();
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞');
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
    setInterval(fetchState, 2000);
    fetchState();
  </script>
</body>
</html>